# Runs conda-lock against environment.yml for reproducible environments
# Runs on any opened PR
name: Conda Lock

on:
  repository_dispatch:
    types: [condalock-command]

permissions:
  contents: read

jobs:
  condalock:
    permissions:
      contents: write # for Git to git push
    runs-on: ubuntu-latest
    timeout-minutes: 360
    defaults:
      run:
        shell: bash -l {0}

    steps:
      # Generate token from CryoInTheCloud bot
      - uses: actions/create-github-app-token@bf559f85448f9380bcfa2899dbdc01eb5b37be3a # v3.0.0-beta.2
        id: app-token
        with:
          app-id: ${{ secrets.APP_ID }}
          private-key: ${{ secrets.APP_PRIVATE_KEY }}

      # Checkout the pull request branch
      - name: Checkout Repository
        uses: actions/checkout@v5
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: ${{ github.event.client_payload.pull_request.head.repo.full_name }}
          ref: ${{ github.event.client_payload.pull_request.head.ref }}
          persist-credentials: true

      # Install conda-lock library with Micromamba
      - name: Install conda-lock with Micromamba
        uses: mamba-org/setup-micromamba@b09ef9b599704322748535812ca03efb2625677b # v2.0.5
        with:
          environment-name: conda-lock-env
          create-args: >-
            python=3.11
            conda-lock
            mamba

      # Generate unified 'conda-lock.yml' and platform-specific lockfiles
      - name: Run conda-lock
        run: |
          conda-lock lock --mamba --file environment.yml --platform linux-64
          conda-lock render --kind explicit --platform linux-64

      # Commit the change to the PR branch if any changes
      - name: Commit condalock files to PR
        run: |
          if [[ $(git ls-files --modified --others) ]]; then
            git config --global user.name 'actions-bot'
            git config --global user.email '58130806+actions-bot@users.noreply.github.com'
            git commit --all --message "[condalock-command] autogenerated conda-lock files"
            git push
          fi

      # Add an emoji reaction to comment to indicate the script completed successfully
      - name: Add reaction
        uses: peter-evans/create-or-update-comment@71345be0265236311c031f5c7866368bd1eff043 # v4.0.0
        with:
          token: ${{ steps.app-token.outputs.token }}
          repository: ${{ github.event.client_payload.github.payload.repository.full_name }}
          comment-id: ${{ github.event.client_payload.github.payload.comment.id }}
          reaction-type: hooray
